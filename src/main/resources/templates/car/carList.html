<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpool Service</title>
    <link rel="stylesheet" href="/css/bodyHeader.css">
    <link rel="stylesheet" href="/css/carList.css">
</head>
<body>
<!-- í—¤ë” Fragment ë¶ˆëŸ¬ì˜¤ê¸° -->
<header th:replace="fragments/bodyheader :: bodyHeader"></header>

<div class="container">
    <div class="search-bar">
        <input type="text" placeholder="Hinted search text">
        <button>ğŸ”</button>
    </div>
    <div class="filter-buttons">
        <button class="filter-button available">ëª¨ì§‘ì¤‘</button>
        <button class="filter-button unavailable">ëª¨ì§‘ë§ˆê°</button>
    </div>
    <!-- ì¹´ë“œ 1 (ëª¨ì§‘ì¤‘) -->
    <div class="card" th:each="carpool, iterStat : ${carpools}">
        <div class="car-icon-container">
            <div class="car-icon">ğŸš—</div>
            <p class="car-model">ì°¨ì¢…: SONATA</p>
        </div>
        <div class="info-container">
            <div class="info">
                <input type="hidden" name="carpoolId" th:value="${carpool.getCarpoolId()}" class="carpool-id"/>
                <p><strong>ì¶œë°œì§€ì—­: </strong><span
                        th:text="${carpool.getFirstStartAddress() + ' ' + carpool.getSecondStartAddress()}"></span>
                </p>
                <p><strong>ê²½ìœ ê°€ëŠ¥ì§€ì—­: </strong><span
                        th:text="${carpool.getFirstTransitAddress1() + ' ' + carpool.getSecondTransitAddress1()}"></span>
                </p>
                <p><strong>ê²½ìœ ê°€ëŠ¥ì§€ì—­: </strong><span
                        th:text="${carpool.getFirstTransitAddress2() + ' ' + carpool.getSecondTransitAddress2()}"></span>
                </p>
                <p><strong>ê²½ìœ ê°€ëŠ¥ì§€ì—­: </strong><span
                        th:text="${carpool.getFirstTransitAddress3() + ' ' + carpool.getSecondTransitAddress3()}"></span>
                </p>
                <p><strong>ë„ì°©ì§€ì—­: </strong><span
                        th:text="${carpool.getFirstArriveAddress() + ' ' + carpool.getSecondArriveAddress()}"></span>
                </p>
                <p><strong>í¬ë§ì¹´í’€ë¹„ìš©: </strong><span
                        th:text="${carpool.getMinDesiredCharge() + ' ~ ' + carpool.getMaxDesiredCharge()}"></span>
                </p>
                <p><strong>í¬ë§í•˜ëŠ” íƒ‘ìŠ¹ì ì„±ë³„: </strong><span th:text="${carpool.getSex()}"></span></p>
                <p><strong>ì†Œê°œ:</strong> í¸ì•ˆí•˜ê²Œ ëª¨ì‹œê² ìŠµë‹ˆë‹¤~</p>
            </div>
            <div class="current-people">ë‚¨ì€ ì¢Œì„: <span th:text="${carpool.getRestSeat()}"></span></div>
            <div th:if="${carpool.getUser().getSex() == null}" class="gender-icon none"></div>
            <div th:if="${carpool.getUser().getSex() != null && carpool.getUser().getSex().equals('ë‚¨ì')}"
                 class="gender-icon male"></div>
            <div th:if="${carpool.getUser().getSex() != null && carpool.getUser().getSex().equals('ì—¬ì')}"
                 class="gender-icon female"></div>
            <div class="actions-container">
                <button class="action-button apply"
                        th:attr="disabled=${isApplieds[iterStat.index] || isMyCarpool[iterStat.index] || carpool.getRestSeat() == 0}"
                        th:classappend="${isApplieds[iterStat.index] || isMyCarpool[iterStat.index] ? 'disabled' : ''}"
                        onclick="openModal(this)">
                    <span th:text="${isMyCarpool[iterStat.index] ? 'ë‚´ê°€ ì˜¬ë¦° ì¹´í’€' : (carpool.getRestSeat() == 0 ? 'ëª¨ì§‘ë§ˆê°' : (isApplieds[iterStat.index] ? 'âœ…ì‹ ì²­ì™„ë£Œ' : 'ì‹ ì²­í•˜ê¸°'))}"></span>
                </button>
                <button class="action-button inquire">ë¬¸ì˜í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ ì°½ êµ¬ì¡° ì¶”ê°€ -->
<div id="applyModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>ìƒì„¸ ì •ë³´ ì…ë ¥</h2>
        <form id="applyForm">
            <label for="phone">ì „í™”ë²ˆí˜¸:</label>
            <input type="text" id="phone" name="phone" required>
            <label for="pickupLocation">í”½ì—… ìš”ì²­ ì§€ì—­:</label>
            <input type="text" id="pickupLocation" name="pickupLocation" required>
            <label for="message">ë©”ì‹œì§€:</label>
            <textarea id="message" name="message" required></textarea>
            <button type="submit">ì‹ ì²­í•˜ê¸°</button>
        </form>
    </div>
</div>

<script>
    function openModal(button) {
        const carpoolId = button.closest('.info-container').querySelector('.carpool-id').value;
        document.getElementById('applyModal').style.display = 'block';
        document.getElementById('applyForm').dataset.carpoolId = carpoolId; // ì¹´í’€ IDë¥¼ ë°ì´í„° ì†ì„±ì— ì €ì¥
    }

    function closeModal() {
        document.getElementById('applyModal').style.display = 'none';
    }

    window.onclick = function (event) {
        if (event.target === document.getElementById('applyModal')) {
            closeModal();
        }
    }

    document.querySelector('.close').addEventListener('click', function () {
        closeModal();
    });

    document.getElementById('applyForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const carpoolId = event.target.dataset.carpoolId; // ì €ì¥ëœ ì¹´í’€ ID ê°€ì ¸ì˜¤ê¸°
        const pickupLocation = document.getElementById('pickupLocation').value; // í”½ì—… ìš”ì²­ ì§€ì—­ ê°€ì ¸ì˜¤ê¸°
        const phone = document.getElementById('phone').value; // í”½ì—… ìš”ì²­ ì§€ì—­ ê°€ì ¸ì˜¤ê¸°
        const message = document.getElementById('message').value; // í”½ì—… ìš”ì²­ ì§€ì—­ ê°€ì ¸ì˜¤ê¸°
        applyCarpool(carpoolId, phone, pickupLocation, message);
        closeModal();
        const button = document.querySelector(`.carpool-id[value="${carpoolId}"]`).closest('.info-container').querySelector('.action-button.apply');
        button.disabled = true;
        button.textContent = 'âœ…ì‹ ì²­ì™„ë£Œ';
    });

    async function applyCarpool(carpoolId, phone, pickupLocation, message) {
        try {
            const response = await fetch('/carpools/requestCarpool', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ carpoolId: carpoolId, phone: phone, pickupLocation: pickupLocation, message: message}),
            });

            const data = await response.json();
            console.log('Success:', data);
            if (!response.ok) {
                throw new Error('Network response was not ok');

            }

            const button = document.querySelector(`.carpool-id[value="${carpoolId}"]`)
                .closest('.info-container')
                .querySelector('.action-button.apply');
            button.disabled = true;
            button.textContent = 'âœ…ì‹ ì²­ì™„ë£Œ';

            alert("ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
            console.error('Error:', error);
            alert('ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }
</script>
</body>
</html>
